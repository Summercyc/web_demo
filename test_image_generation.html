<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通义万象图片生成测试</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #5A7CA8;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #5A7CA8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #4a6a96;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .image-container {
            margin-top: 20px;
            text-align: center;
        }
        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #5A7CA8;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        .success {
            color: #2ecc71;
            margin-top: 10px;
        }
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>通义万象图片生成测试</h1>
        
        <div class="form-group">
            <label for="apiKey">API Key:</label>
            <input type="password" id="apiKey" placeholder="输入您的通义万象API Key">
        </div>
        
        <div class="form-group">
            <label for="treeType">树木类型:</label>
            <select id="treeType">
                <option value="oak">橡树</option>
                <option value="cherry">樱花树</option>
                <option value="bamboo">竹子</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="season">季节:</label>
            <select id="season">
                <option value="spring">春天</option>
                <option value="summer">夏天</option>
                <option value="autumn">秋天</option>
                <option value="winter">冬天</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="level">成长等级 (1-10):</label>
            <input type="number" id="level" min="1" max="10" value="3">
        </div>
        
        <button id="generateBtn">生成树木图片</button>
        
        <div class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>正在生成图片，请稍候...</p>
        </div>
        
        <div class="result" style="display: none;">
            <h3>生成结果</h3>
            <div id="resultMessage"></div>
            <div class="image-container">
                <img id="resultImage" src="" alt="生成的树木图片">
            </div>
        </div>
        
        <div class="log" id="logContainer">
            <div>日志输出:</div>
        </div>
    </div>

    <script>
        // 缓存对象
        const treeImageCache = {};
        
        // 日志函数
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 生成提示词
        function generateTreePrompt(type, season, level) {
            let basePrompt = '';
            let stageDesc = '';
            
            // 树木类型描述
            if (type === 'oak') {
                basePrompt = '一棵橡树';
            } else if (type === 'cherry') {
                basePrompt = '一棵樱花树';
            } else { // bamboo
                basePrompt = '一棵竹子';
            }
            
            // 成长阶段描述
            if (level <= 1) {
                stageDesc = '刚刚发芽的幼苗';
            } else if (level <= 3) {
                stageDesc = '小小的幼苗，有几片嫩叶';
            } else if (level <= 5) {
                stageDesc = '成长中的小树，有一些枝叶';
            } else if (level <= 8) {
                stageDesc = '茁壮成长的树，枝繁叶茂';
            } else {
                stageDesc = '高大茂盛的成熟树，非常壮观';
            }
            
            // 季节描述
            let seasonDesc = '';
            switch (season) {
                case 'spring':
                    seasonDesc = '春天，背景有嫩绿的草地和蓝天';
                    break;
                case 'summer':
                    seasonDesc = '夏天，阳光明媚，树叶翠绿';
                    break;
                case 'autumn':
                    seasonDesc = '秋天，树叶变黄或红色，有落叶';
                    break;
                case 'winter':
                    seasonDesc = '冬天，可能有雪，树木安静';
                    break;
            }
            
            // 特殊效果
            let specialEffect = '';
            if (type === 'cherry' && season === 'spring' && level >= 5) {
                specialEffect = '，盛开的粉色花朵';
            } else if (type === 'oak' && season === 'autumn' && level >= 5) {
                specialEffect = '，金黄色的橡树叶';
            }
            
            // 组合提示词
            return `${basePrompt}，${stageDesc}${specialEffect}，${seasonDesc}，高清写实风格，温暖柔和的光线，自然场景`;
        }
        
        // 调用通义万象API生成图片
        async function generateTreeImageWithWanxiang(prompt, apiKey) {
            log(`开始生成图片，提示词: ${prompt}`);
            
            if (!apiKey) {
                throw new Error('未设置API Key');
            }
            
            // 步骤1：提交图片生成任务
            log('步骤1: 提交图片生成任务...');
            const taskResponse = await fetch('http://localhost:3000/api/dashscope/api/v1/services/aigc/text2image/image-synthesis', {
                method: 'POST',
                headers: {
                    'X-DashScope-Async': 'enable',
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'wan2.2-t2i-flash',
                    input: {
                        prompt: prompt
                    },
                    parameters: {
                        size: '1024*1024',
                        n: 1
                    }
                })
            });
            
            if (!taskResponse.ok) {
                const errorText = await taskResponse.text();
                log(`提交任务失败: ${taskResponse.status} - ${errorText}`);
                throw new Error(`提交图片生成任务失败: ${taskResponse.status} - ${errorText}`);
            }
            
            const taskData = await taskResponse.json();
            log(`任务提交成功，任务ID: ${taskData.output.task_id}`);
            const taskId = taskData.output.task_id;
            
            // 步骤2：轮询获取结果
            log('步骤2: 轮询获取结果...');
            let imageUrl = null;
            let retries = 0;
            const maxRetries = 10;
            
            while (retries < maxRetries) {
                log(`等待2秒后检查结果 (尝试 ${retries + 1}/${maxRetries})...`);
                await new Promise(resolve => setTimeout(resolve, 2000)); // 等待2秒
                
                const resultResponse = await fetch(`http://localhost:3000/api/dashscope/api/v1/tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!resultResponse.ok) {
                    log(`获取结果失败: ${resultResponse.status}`);
                    retries++;
                    continue;
                }
                
                const resultData = await resultResponse.json();
                log(`获取到任务状态: ${resultData.output.task_status}`);
                
                if (resultData.output.task_status === 'SUCCEEDED') {
                    imageUrl = resultData.output.results[0].url;
                    log(`图片生成成功! URL: ${imageUrl}`);
                    break;
                } else if (resultData.output.task_status === 'FAILED') {
                    const errorMessage = resultData.output.message || '未知错误';
                    log(`图片生成失败: ${errorMessage}`);
                    throw new Error(`图片生成失败: ${errorMessage}`);
                }
                
                retries++;
            }
            
            if (!imageUrl) {
                log('图片生成超时');
                throw new Error('图片生成超时');
            }
            
            return imageUrl;
        }
        
        // 主函数：生成图片
        async function generateImage() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const treeType = document.getElementById('treeType').value;
            const season = document.getElementById('season').value;
            const level = parseInt(document.getElementById('level').value);
            
            if (!apiKey) {
                alert('请输入API Key');
                return;
            }
            
            const cacheKey = `${treeType}-${season}-${level}`;
            
            // 检查缓存
            if (treeImageCache[cacheKey]) {
                log('使用缓存的图片');
                showResult(treeImageCache[cacheKey], true);
                return;
            }
            
            // 显示加载状态
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.result').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
            
            try {
                // 生成提示词
                const prompt = generateTreePrompt(treeType, season, level);
                log(`生成的提示词: ${prompt}`);
                
                // 调用API生成图片
                const imageUrl = await generateTreeImageWithWanxiang(prompt, apiKey);
                
                // 缓存图片URL
                treeImageCache[cacheKey] = imageUrl;
                
                // 显示结果
                showResult(imageUrl);
                
            } catch (error) {
                console.error('生成树木图片失败:', error);
                log(`错误: ${error.message}`);
                
                const resultMessage = document.getElementById('resultMessage');
                resultMessage.innerHTML = `<div class="error">生成失败: ${error.message}</div>`;
                document.querySelector('.result').style.display = 'block';
                
            } finally {
                // 隐藏加载状态
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        // 显示结果
        function showResult(imageUrl, fromCache = false) {
            const resultMessage = document.getElementById('resultMessage');
            const resultImage = document.getElementById('resultImage');
            
            resultMessage.innerHTML = fromCache ? 
                '<div class="success">使用缓存的图片</div>' : 
                '<div class="success">图片生成成功!</div>';
            
            resultImage.src = imageUrl;
            document.querySelector('.result').style.display = 'block';
        }
        
        // 绑定按钮事件
        document.getElementById('generateBtn').addEventListener('click', generateImage);
        
        // 初始化日志
        log('测试页面已加载，请输入API Key并设置参数');
    </script>
</body>
</html>