<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - AI圆桌 · 成长对话</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <!-- 使用本地Tailwind CSS文件，如果加载失败则回退到CDN -->
    <link rel="stylesheet" href="tailwind.min.css" onerror="this.onerror=null;this.href='https://cdn.tailwindcss.com';">
    <link rel="stylesheet" href="style.css">
    <script>
        // 安全配置 Tailwind CSS
        function configureTailwind() {
            if (typeof tailwind !== 'undefined' && tailwind.config) {
                try {
                    tailwind.config = {
                        theme: {
                            extend: {
                                colors: {
                                    'warm-blue': '#5A7CA8',
                                    'morning-orange': '#FF9A4D',
                                    'light-cream': '#FEFCF7'
                                }
                            }
                        }
                    };
                    console.log('Tailwind 配置已成功应用');
                } catch (error) {
                    console.warn('Tailwind 配置失败:', error);
                }
            }
        }

        // 检查是否需要加载Tailwind CDN
        document.addEventListener('DOMContentLoaded', function() {
            // 先尝试配置本地 Tailwind
            configureTailwind();
            
            // 检查样式是否生效
            setTimeout(function() {
                const style = getComputedStyle(document.body);
                if (style.backgroundColor !== 'rgb(254, 252, 247)') { // 检查light-cream背景色是否生效
                    const script = document.createElement('script');
                    script.src = 'https://cdn.tailwindcss.com';
                    script.onload = function() {
                        // Tailwind CDN 加载完成后配置
                        setTimeout(configureTailwind, 100);
                    };
                    document.head.appendChild(script);
                    console.log('已加载Tailwind CDN作为备用');
                }
            }, 100);
        });
    </script>
</head>
<body class="bg-light-cream font-sans">
    <div class="min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <a href="index.html" class="text-xl font-bold text-warm-blue">AI圆桌 · 个人中心</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="currentUsername" class="text-gray-600 mr-4"></span>
                        <button id="logoutBtn" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                            退出登录
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <div class="flex-1 flex">
            <!-- 侧边栏 -->
            <div class="w-64 bg-white shadow-sm">
                <div class="p-4">
                    <h2 class="text-lg font-medium text-gray-900">个人中心</h2>
                </div>
                <nav class="mt-2">
                    <a href="#" class="flex items-center px-4 py-3 text-sm font-medium text-warm-blue bg-blue-50 border-l-4 border-warm-blue">
                        <svg class="mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        个人信息
                    </a>
                    <a href="#" id="changePasswordLink" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                        <svg class="mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        修改密码
                    </a>
                    <a href="index.html" class="flex items-center px-4 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                        <svg class="mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        返回首页
                    </a>
                </nav>
            </div>

            <!-- 内容区 -->
            <div class="flex-1 p-8">
                <div class="max-w-3xl mx-auto">
                    <!-- 错误提示 -->
                    <div id="errorAlert" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden mb-4" role="alert">
                        <span id="errorMessage" class="block sm:inline"></span>
                    </div>
                    
                    <!-- 成功提示 -->
                    <div id="successAlert" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative hidden mb-4" role="alert">
                        <span id="successMessage" class="block sm:inline"></span>
                    </div>
                    
                    <!-- 个人信息区域 -->
                    <div id="profileSection" class="bg-white shadow overflow-hidden sm:rounded-lg">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">个人信息</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">您的账户详细信息</p>
                        </div>
                        <div class="border-t border-gray-200">
                            <dl>
                                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">用户名</dt>
                                    <dd id="profileUsername" class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">加载中...</dd>
                                </div>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">电子邮箱</dt>
                                    <dd id="profileEmail" class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">加载中...</dd>
                                </div>
                                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">角色</dt>
                                    <dd id="profileRole" class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">加载中...</dd>
                                </div>
                                <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">注册时间</dt>
                                    <dd id="profileCreatedAt" class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">加载中...</dd>
                                </div>
                                <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">最后登录</dt>
                                    <dd id="profileLastLogin" class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">加载中...</dd>
                                </div>
                            </dl>
                        </div>
                        <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                            <button id="editProfileBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-warm-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-warm-blue">
                                编辑信息
                            </button>
                        </div>
                    </div>
                    
                    <!-- 修改密码区域 -->
                    <div id="changePasswordSection" class="bg-white shadow overflow-hidden sm:rounded-lg mt-6 hidden">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">修改密码</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">更新您的账户密码</p>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
                            <form id="changePasswordForm" class="space-y-6">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium text-gray-700">当前密码</label>
                                    <div class="mt-1">
                                        <input id="currentPassword" name="currentPassword" type="password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-warm-blue focus:border-warm-blue sm:text-sm">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700">新密码</label>
                                    <div class="mt-1">
                                        <input id="newPassword" name="newPassword" type="password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-warm-blue focus:border-warm-blue sm:text-sm">
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">密码长度不能少于6个字符</p>
                                </div>
                                
                                <div>
                                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">确认新密码</label>
                                    <div class="mt-1">
                                        <input id="confirmNewPassword" name="confirmNewPassword" type="password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-warm-blue focus:border-warm-blue sm:text-sm">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end">
                                    <button type="button" id="cancelChangePassword" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-warm-blue mr-3">
                                        取消
                                    </button>
                                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-warm-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-warm-blue">
                                        保存
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑个人信息模态框 -->
    <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-96 max-w-90vw">
            <h3 class="text-xl font-medium mb-4">编辑个人信息</h3>
            
            <div class="mb-4">
                <label for="editEmail" class="block text-sm font-medium text-gray-700 mb-1">电子邮箱</label>
                <input type="email" id="editEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-warm-blue focus:border-warm-blue" placeholder="电子邮箱">
            </div>
            
            <div class="flex space-x-3">
                <button id="cancelEditProfile" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50">
                    取消
                </button>
                <button id="confirmEditProfile" class="flex-1 py-2 px-4 bg-warm-blue text-white rounded-lg hover:bg-blue-600">
                    保存更改
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户是否已登录
            checkAuthStatus();
            
            // 获取用户信息
            loadUserProfile();
            
            // 退出登录按钮点击事件
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 编辑个人信息按钮点击事件
            document.getElementById('editProfileBtn').addEventListener('click', openEditProfileModal);
            
            // 编辑个人信息模态框
            const editProfileModal = document.getElementById('editProfileModal');
            document.getElementById('cancelEditProfile').addEventListener('click', () => {
                editProfileModal.classList.add('hidden');
            });
            document.getElementById('confirmEditProfile').addEventListener('click', saveProfileChanges);
            
            // 修改密码链接点击事件
            document.getElementById('changePasswordLink').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('profileSection').classList.add('hidden');
                document.getElementById('changePasswordSection').classList.remove('hidden');
            });
            
            // 取消修改密码按钮点击事件
            document.getElementById('cancelChangePassword').addEventListener('click', function() {
                document.getElementById('changePasswordSection').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
                document.getElementById('changePasswordForm').reset();
            });
            
            // 修改密码表单提交事件
            document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });
        });
        
        // 检查用户是否已登录
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include' // 包含Cookie
                });
                
                if (!response.ok) {
                    // 用户未登录，重定向到登录页面
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('检查登录状态时出错:', error);
                window.location.href = 'login.html';
            }
        }
        
        // 加载用户个人信息
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include' // 包含Cookie
                });
                
                if (!response.ok) {
                    throw new Error('获取用户信息失败');
                }
                
                const data = await response.json();
                const user = data.user;
                
                // 更新页面显示
                document.getElementById('currentUsername').textContent = user.username;
                document.getElementById('profileUsername').textContent = user.username;
                document.getElementById('profileEmail').textContent = user.email || '未设置';
                document.getElementById('profileRole').textContent = user.role === 'admin' ? '管理员' : '普通用户';
                document.getElementById('profileCreatedAt').textContent = formatDate(user.created_at);
                document.getElementById('profileLastLogin').textContent = user.last_login ? formatDate(user.last_login) : '从未登录';
            } catch (error) {
                console.error('加载用户信息时出错:', error);
                showError(error.message);
            }
        }
        
        // 打开编辑个人信息模态框
        function openEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            const email = document.getElementById('profileEmail').textContent;
            
            // 填充表单
            document.getElementById('editEmail').value = email === '未设置' ? '' : email;
            
            // 显示模态框
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        // 保存个人信息更改
        async function saveProfileChanges() {
            const modal = document.getElementById('editProfileModal');
            const email = document.getElementById('editEmail').value;
            
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    credentials: 'include' // 包含Cookie
                });
                
                if (!response.ok) {
                    throw new Error('获取用户信息失败');
                }
                
                const data = await response.json();
                const userId = data.user.id;
                
                // 更新用户信息
                const updateResponse = await fetch(`/api/auth/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email }),
                    credentials: 'include' // 包含Cookie
                });
                
                if (!updateResponse.ok) {
                    const updateData = await updateResponse.json();
                    throw new Error(updateData.error || '更新用户信息失败');
                }
                
                // 隐藏模态框
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // 显示成功消息
                showSuccess('个人信息更新成功');
                
                // 重新加载用户信息
                loadUserProfile();
            } catch (error) {
                console.error('保存个人信息时出错:', error);
                showError(error.message);
            }
        }
        
        // 修改密码
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            // 验证密码
            if (newPassword !== confirmNewPassword) {
                showError('两次输入的新密码不一致');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('新密码长度不能少于6个字符');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword }),
                    credentials: 'include' // 包含Cookie
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '修改密码失败');
                }
                
                // 显示成功消息
                showSuccess('密码修改成功');
                
                // 重置表单
                document.getElementById('changePasswordForm').reset();
                
                // 返回个人信息页面
                document.getElementById('changePasswordSection').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
            } catch (error) {
                console.error('修改密码时出错:', error);
                showError(error.message);
            }
        }
        
        // 退出登录
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include' // 包含Cookie
                });
                
                // 重定向到登录页面
                window.location.href = 'login.html';
            } catch (error) {
                console.error('退出登录时出错:', error);
                showError(error.message);
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 显示错误消息
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                errorAlert.classList.add('hidden');
            }, 5000);
        }
        
        // 显示成功消息
        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            const successMessage = document.getElementById('successMessage');
            
            successMessage.textContent = message;
            successAlert.classList.remove('hidden');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>